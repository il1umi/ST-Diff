# ST-Diff

一个为 SillyTavern 设计的差异对比扩展，提供世界书条目的可视化对比、条目内容迁移功能。未来会加入预设功能。

![版本](https://img.shields.io/badge/版本-1.0.0-blue.svg)
![许可证](https://img.shields.io/badge/许可证-AGPL--3.0-blue.svg)

## 功能概览

ST-Diff 是一个专为 SillyTavern 世界书（预设）管理设计的扩展，能够：

- **可视化差异对比** - 提供并列和内联两种对比模式，清晰展示世界书条目间的差异
- **智修内容迁移** - 支持单向应用和撤销操作
- **实时编辑预览** - 在对比界面中直接编辑内容，实时查看修改效果
- **版本管理** - 支持世界书条目的版本对比和历史追踪
- **批量保存** - 提供"保存全部"、"仅保存世界书A"、"仅保存世界书B"等灵活保存选项
- **高度可定制** - 支持自定义颜色主题、上下文行数、词级高亮等个性化设置

## 项目结构

```
ST-Diff/
├── modules/                           # 核心功能模块
│   ├── worldbook/                     # 世界书对比模块
│   │   ├── actions/                   # 操作处理器
│   │   │   ├── hunks.js              # Hunk 操作逻辑
│   │   │   └── sessionPatch.js       # 会话补丁管理
│   │   ├── templates/                 # HTML 模板
│   │   │   ├── code_diff.html        # 代码对比界面模板
│   │   │   └── entry_diff.html       # 条目对比界面模板
│   │   ├── codeDiff.js               # 代码级差异对比引擎
│   │   ├── diff.js                   # 差异计算核心
│   │   ├── entryDiff.js              # 条目级差异处理
│   │   ├── repo.js                   # 世界书仓库接口
│   │   ├── worldbook.module.js       # 世界书模块主控制器
│   │   └── panel.html                # 主面板模板
│   └── presets/                       # 预设对比模块（占位）
├── presentation/                      # UI 表现层
│   ├── styles/                       # 样式文件
│   │   └── main.css                  # 主样式表
│   └── templates/                    # 全局模板
│       └── main.html                 # 主界面模板
├── index.js                          # 主入口文件
├── manifest.json                     # 扩展清单文件
└── README.md                         # 项目文档
```

## 使用方法

### 安装

#### 方法一：通过 Git 克隆安装

1. **进入扩展目录**
   ```bash
   cd SillyTavern/public/scripts/extensions/third-party/
   ```

2. **克隆仓库**
   ```bash
   git clone https://github.com/il1umi/ST-Diff.git
   ```

3. **重启并启用**
   - 重启您的 SillyTavern 实例
   - 打开"扩展"面板，找到"酒馆构筑对比工具"并启用

#### 方法二：通过 URL 在线安装

在 SillyTavern 的扩展管理界面中，使用以下 URL 进行在线安装：
```
https://github.com/il1umi/ST-Diff.git
```

### 基础使用

1. **启用扩展**
   - 在扩展面板中启用"酒馆构筑对比工具"

2. **选择对比目标**
   - 在世界书编辑界面，选择要对比的两个世界书
   - 点击"展开对比"按钮

3. **查看差异**
   - 系统会自动计算并展示两个世界书间的差异
   - 支持并列和内联两种查看模式

4. **应用修改**
   - 点击差异块旁的"应用"按钮将更改应用到目标世界书
   - 使用"撤销"功能回退不需要的更改

## 核心功能详解

### 差异对比引擎

#### 多层次对比
- **条目级对比**：识别新增、删除、修改的世界书条目
- **内容级对比**：深入到条目内容的行级和词级差异
- **结构化对比**：支持 JSON 格式的规范化对比

#### 可视化展示
- **并列模式**：左右分栏显示两个版本，便于逐行对比
- **内联模式**：在同一视图中标记差异，节省屏幕空间
- **语法高亮**：支持多种内容格式的语法着色

### 智能修复系统

#### 修复策略
- **单向应用**：将 A 侧的更改应用到 B 侧，或反之
- **智能合并**：在不冲突的情况下自动合并更改
- **撤销机制**：支持单步撤销和批量撤销操作

### 版本管理

#### 会话状态管理
- **实时同步**：修改内容实时反映在对比界面中
- **状态持久化**：会话状态在页面刷新后保持
- **历史追踪**：记录所有应用的修改操作

#### 保存机制
- **验证保存**：保存后自动验证内容是否正确写入
- **批量操作**：支持同时保存多个修改
- **回滚支持**：保存失败时提供回滚选项

## 使用指南

### 创建对比会话

1. **选择源世界书**
   - 在世界书编辑器中选择要作为基准的世界书

2. **选择目标世界书**
   - 从下拉列表中选择要对比的另一个世界书

3. **配置对比选项**
   - 设置上下文行数（默认为 3）
   - 选择是否忽略空白字符差异
   - 启用或禁用词级高亮

4. **开始对比**
   - 点击"展开对比"按钮启动对比分析

### 理解差异显示

#### 颜色高亮
- **绿色背景**：新增的内容（可自定义颜色）
- **红色背景**：删除的内容（可自定义颜色）
- **黄色高亮**：词级差异标记（可自定义颜色）
- **灰色文本**：上下文行（未修改的内容）（可自定义颜色）

#### 操作按钮
- **应用**：将当前差异块应用到目标侧
- **撤销上一步**：撤销最近的一次应用操作
- **撤销全部**：撤销所有已应用的操作

### 高级配置

#### 显示选项
- **上下文行数**：控制差异块周围显示的上下文行数
- **折叠相同内容**：自动折叠大段相同的内容
- **同步滚动**：在并列模式下同步左右面板的滚动

#### 颜色主题
- **行级颜色**：自定义新增和删除行的背景色
- **词级颜色**：自定义词级差异的高亮色
- **调色板**：提供预设的颜色方案

## 高级功能

### 自定义扩展

#### 添加新的对比模块
```javascript
// 注册新的对比模块
const myModule = {
  name: 'my-custom-module',
  displayName: '自定义模块',
  async initialize(ctx) {
    // 模块初始化逻辑
  }
};

// 在主入口中注册
registerModule(myModule);
```

#### 自定义差异算法
```javascript
// 实现自定义差异计算
class CustomDiffAlgorithm {
  computeDiff(textA, textB, options) {
    // 自定义差异计算逻辑
    return diffResult;
  }
}
```


## 贡献指南

欢迎社区贡献！请遵循以下步骤：

1. **Fork 项目**
2. **创建功能分支** (`git checkout -b feature/NewFeature`)
3. **提交更改** (`git commit -m 'Add some NewFeature'`)
4. **推送分支** (`git push origin feature/NewFeature`)
5. **创建 Pull Request**

## 许可证

本项目采用 GNU AGPLv3 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。

### 版权信息

Copyright (C) 2025 shin/il1umi

## 支持与反馈

- **Issues**：[GitHub Issues](https://github.com/il1umi/ST-Diff/issues)
- **讨论**：[GitHub Discussions](https://github.com/il1umi/ST-Diff/discussions)


