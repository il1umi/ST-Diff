# ST-Diff

一个为 SillyTavern 设计的差异对比扩展，提供世界书条目的可视化对比、条目内容迁移功能。未来会加入预设功能。

![版本](https://img.shields.io/badge/版本-1.2.0-blue.svg)
![许可证](https://img.shields.io/badge/许可证-AGPL--3.0-blue.svg)

## 致谢
感谢类脑discord社区tera佬及折戟沉沙佬的clewd正则、jsrunner代码及思路启发对本扩展的noass功能的不可磨灭的贡献
## 功能概览

ST-Diff 是一个专为 SillyTavern 世界书管理设计的扩展，能够：

- **可视化差异对比** - 提供并列和内联两种对比模式，清晰展示世界书条目间的差异
- **条目详情参数对比** - 支持世界书条目的所有参数（关键字、逻辑、位置、概率等）的并排对比与编辑
- **智能内容迁移** - 支持单向应用和撤销操作，可选择性应用差异块
- **实时编辑预览** - 在对比界面中直接编辑内容，实时查看修改效果
- **暂存模式** - 支持手动保存模式，批量提交修改，避免频繁写盘
- **版本管理** - 支持世界书条目的版本对比和历史追踪
- **对话压缩和世界书提取与传递** - 支持压缩消息为单条并将世界书深度条目从chathistory剥离并任意放置
- **高度可定制** - 支持自定义颜色主题、上下文行数、词级高亮等个性化设置

## 项目结构

```
ST-Diff/
├── modules/                           # 核心功能模块
│   ├── noass/                         # 对话合并 & clewd 正则 & 世界书提取/剥离
│   │   └── noass.module.js            # noass 模块主逻辑
│   ├── worldbook/                     # 世界书对比模块
│   │   ├── actions/                   # 操作处理器
│   │   │   ├── hunks.js              # Hunk 操作逻辑
│   │   │   └── sessionPatch.js       # 会话补丁管理
│   │   ├── templates/                 # HTML 模板
│   │   │   ├── code_diff.html        # 代码对比界面模板
│   │   │   └── entry_diff.html       # 条目对比界面模板
│   │   ├── codeDiff.js               # 代码级差异对比引擎
│   │   ├── diff.js                   # 差异计算核心
│   │   ├── entryDiff.js              # 条目级差异处理
│   │   ├── paramsDiff.js             # 条目参数对比与编辑
│   │   ├── repo.js                   # 世界书仓库接口
│   │   ├── worldbook.module.js       # 世界书模块主控制器
│   │   └── panel.html                # 主面板模板
│   └── presets/                       # 预设对比模块（占位）
├── presentation/                      # UI 表现层
│   ├── styles/                       # 样式文件
│   │   └── main.css                  # 主样式表
│   └── templates/                    # 全局模板
│       └── main.html                 # 主界面模板
├── index.js                          # 主入口文件
├── manifest.json                     # 扩展清单文件
└── README.md                         # 项目文档
```

## 使用方法

### 安装

#### 方法一：通过 Git 克隆安装

1. **进入扩展目录**
   ```bash
   cd SillyTavern/public/scripts/extensions/third-party/
   ```

2. **克隆仓库**
   ```bash
   git clone https://github.com/il1umi/ST-Diff.git
   ```

3. **重启并启用**
   - 重启您的 SillyTavern 实例
   - 打开"扩展"面板，找到"酒馆构筑对比工具"并启用

#### 方法二：通过 URL 在线安装

在 SillyTavern 的扩展管理界面中，使用以下 URL 进行在线安装：
```
https://github.com/il1umi/ST-Diff.git
```

### 基础使用

1. **启用扩展**
   - 在扩展面板中启用"酒馆构筑对比工具"

2. **选择对比目标**
   - 在世界书编辑界面，选择要对比的两个世界书（世界书A和世界书B）
   - 可选择"只读模式"防止误修改世界书B
   - 默认勾选手动模式防止参数页误操作

3. **查看差异**
   - **内容对比**：点击"展开对比"查看条目内容的文本差异，支持并列和内联两种模式
   - **参数对比**：展开任意条目详情，查看世界书B的对应参数（关键字、逻辑、位置、概率等）

4. **编辑与保存**
   - **即时保存**：关闭"暂存模式"，修改世界书B的参数后立即保存
   - **暂存模式**：开启后，修改会暂存在内存中，点击"保存暂存"统一写入磁盘
   - **内容迁移**：在内容对比界面点击"应用"按钮将差异块应用到目标世界书

## 核心功能详解

### 差异对比引擎

#### 多层次对比
- **条目级对比**：识别新增、删除、修改的世界书条目
- **内容级对比**：深入到条目内容的行级和词级差异
- **参数级对比**：支持条目详情中所有参数的并排对比与实时编辑
- **结构化对比**：支持 JSON 格式的规范化对比

#### 可视化展示
- **并列模式**：左右分栏显示两个版本，便于逐行对比
- **内联模式**：在同一视图中标记差异，节省屏幕空间
- **参数对比**：在条目详情中显示世界书B的对应参数，支持实时编辑
- **语法高亮**：支持多种内容格式的语法着色

### 智能编辑系统

#### 编辑策略
- **参数级编辑**：直接在条目详情中编辑世界书B的参数，支持关键字、逻辑、位置、概率等所有字段
- **内容级应用**：将 A 侧的内容更改应用到 B 侧，支持选择性应用差异块
- **暂存机制**：支持暂存模式，批量提交修改，避免频繁磁盘写入
- **撤销机制**：支持单步撤销和批量撤销操作

### 版本管理

#### 会话状态管理
- **实时同步**：修改内容实时反映在对比界面中
- **状态持久化**：会话状态在页面刷新后保持
- **历史追踪**：记录所有应用的修改操作

#### 保存机制
- **即时保存**：关闭暂存模式时，参数修改立即写入世界书文件
- **暂存保存**：开启暂存模式时，修改暂存在内存中，手动触发批量保存
- **验证保存**：保存后自动验证内容是否正确写入
- **回滚支持**：保存失败时提供回滚选项

## 使用指南

### 创建对比会话

1. **选择源世界书**
   - 在世界书编辑器中选择要作为基准的世界书

2. **选择目标世界书**
   - 从下拉列表中选择要对比的另一个世界书

3. **配置对比选项**
   - 设置上下文行数（默认为 3）
   - 选择是否忽略空白字符差异
   - 启用或禁用词级高亮
   - 选择"只读模式"或"暂存模式"

4. **开始对比**
   - **内容对比**：点击"展开对比"按钮启动内容差异分析
   - **参数对比**：直接展开条目详情查看参数对比

### 理解差异显示

#### 颜色高亮
- **绿色背景**：新增的内容（可自定义颜色）
- **红色背景**：删除的内容（可自定义颜色）
- **黄色高亮**：词级差异标记（可自定义颜色）
- **灰色文本**：上下文行（未修改的内容）（可自定义颜色）

#### 操作按钮
- **应用**：将当前差异块应用到目标侧（内容对比界面）
- **保存暂存**：批量保存所有暂存的参数修改（参数对比界面）
- **撤销上一步**：撤销最近的一次应用操作
- **撤销全部**：撤销所有已应用的操作

### 高级配置

#### 显示选项
- **上下文行数**：控制差异块周围显示的上下文行数
- **折叠相同内容**：自动折叠大段相同的内容
- **同步滚动**：在并列模式下同步左右面板的滚动
- **只读模式**：防止误修改世界书B，仅允许查看对比
- **暂存模式**：开启后修改暂存在内存中，需手动保存

#### 颜色主题
- **行级颜色**：自定义新增和删除行的背景色
- **词级颜色**：自定义词级差异的高亮色
- **调色板**：提供预设的颜色方案

#### 参数对比功能
- **支持的参数**：关键字、逻辑、位置、概率、深度、顺序、组权重、扫描深度、递归设置、角色过滤等
- **实时编辑**：在对比界面中直接编辑世界书B的参数
- **同名匹配**：基于条目标题自动匹配对应的世界书B条目

## 高级功能

### 自定义扩展

#### 添加新的对比模块
```javascript
// 注册新的对比模块
const myModule = {
  name: 'my-custom-module',
  displayName: '自定义模块',
  async initialize(ctx) {
    // 模块初始化逻辑
  }
};

// 在主入口中注册
registerModule(myModule);
```

#### 自定义差异算法
```javascript
// 实现自定义差异计算
class CustomDiffAlgorithm {
  computeDiff(textA, textB, options) {
    // 自定义差异计算逻辑
    return diffResult;
  }
}
```


## 贡献指南

欢迎社区贡献！请遵循以下步骤：

1. **Fork 项目**
2. **创建功能分支** (`git checkout -b feature/NewFeature`)
3. **提交更改** (`git commit -m 'Add some NewFeature'`)
4. **推送分支** (`git push origin feature/NewFeature`)
5. **创建 Pull Request**

## 许可证

本项目采用 GNU AGPLv3 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。

### 版权信息

Copyright (C) 2025 shin/il1umi

## 支持与反馈

- **Issues**：[GitHub Issues](https://github.com/il1umi/ST-Diff/issues)
- **讨论**：[GitHub Discussions](https://github.com/il1umi/ST-Diff/discussions)


