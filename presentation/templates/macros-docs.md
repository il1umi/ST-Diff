# ST-Diff 宏模块使用说明

> 本文档介绍扩展扩展提供的 `{{roulette}}` 与 `{{cascade}}` 宏。  
> 你可以在「扩展 → 酒馆构筑对比工具 → 宏管理」中配置宏组
> 注意：由于酒馆的宏引擎仅支持“内置正则宏”（即酒馆自带的宏）和“键名宏”（允许扩展注册的宏）。因此我们暂时无法像内置宏那样用逗号/双冒号参数化语法直接扩展（即“即时语法”部分暂时不会生效），目前只能使用我们已注册的键名宏（通过UI配置{{roulette_<groupId>}} / {{cascade_<groupId>}}这样的“键名宏”。后续若有需求可能会加入。

---
# 本扩展的自定义宏的元素权重为相对权重。即单个元素的权重与元素池的总权重的计算方式为 weight_i / Σ weight 计算。

## `{{roulette}}` 加权随机宏

`roulette` 宏用于在一组候选项中按权重进行随机选择，类似可自定义扇区大小的抽奖轮盘

### 即时语法（仅作示意用，无法直接使用）


- 基本格式（逗号分隔）：

  ```text
  {{roulette:值1|权重1, 值2|权重2, ...}}
  ```

- 等价的双冒号分隔格式：

  ```text
  {{roulette:值1|权重1::值2|权重2::...}}
  ```

- 权重说明：
  - 权重可以是整数或小数，会自动归一化为概率。
  - 省略权重时默认视为 `1`。
  - 当所有有效权重都为 `0` 或候选为空时，会退化为等概率随机或直接返回原始宏文本，并在控制台输出 `[ST-Diff][roulette]` 日志。
  

### 宏组语法

在「宏管理 → Roulette 宏」面板中，可以配置命名宏组。
- 配置项：宏组/名称：在名称处自定义你的这个宏组的名字，“宏组”处可以点击切换不同的宏组
- 配置项：调用名（ID）：非常关键，作为宏的正确语法的一部分，如下：

假设创建了一个 ID 为 `loot` 的组：

- 组内配置：

  ```text
  奖励A|0.2
  奖励B|0.5
  奖励C|0.3
  ```

- 使用方式：输入以下格式：

  ```text
  {{roulette_loot}}
  ```

这等价于：

```text
{{roulette:奖励A|0.2::奖励B|0.5::奖励C|0.3}}
```
即：该宏执行完毕后，会根据对应元素的概率占比抛出对应的结果。以“奖励A”为例子，其被选中的概率为（0.2/0.2+0.5+0.3）=0.2，即有0.2的概率：`{{roulette:奖励A|0.2::奖励B|0.5::奖励C|0.3}}`=`奖励A`
### 嵌套示例

下面示例模拟“开宝箱”：

```text
{{roulette:
  100金币|0.7::
  {{random::治疗药水::法力药水}}|0.25::
  {{random::铁剑::木盾}}|0.05
}}
```

- 外层 `roulette` 先按权重选择一个候选项；
- 若选中包含其它宏的项（例如 `{{random::...}}`），会继续执行该宏并返回展开后的结果；
- 宏展开遵循酒馆全局的宏解析顺序与嵌套深度限制（默认 16 层左右），出现循环或过深嵌套时会中止并给出警告。

### 其它行为说明

- 宏组可以在 UI 中设置「禁止连续重复」，避免多次调用得到完全相同结果；
- 配置持久化在 `extensionSettings['st-diff'].macros.roulette` 下，可通过「导入/导出配置」备份与迁移。

---

## `{{cascade}}` 瀑布式展开宏

`cascade` 宏用于生成由多行随机元素构成的文本块，行数与每行内容都具随机性

### 即时语法（仅作示意用，无法直接使用）

- 双冒号格式：

  ```text
  {{cascade:范围::元素1::元素2::...::元素N}}
  ```

- `范围` 为 `min-max` 形式（闭区间），例如：
  - `3-5` 表示生成 3～5 行；
  - `10-10` 等价于固定 10 行。

执行流程：

1. 在 `[min, max]` 区间内随机选择一个整数 `N`；
2. 循环 `N` 次，每次从元素池中随机选择一个元素；
3. 将每次选择的结果以换行符拼接输出。

示例：

```text
{{cascade:3-5::写代码::喝咖啡::看文档}}
```

可能输出（总共3到5行）：

```text
喝咖啡
写代码
喝咖啡
看文档
```

### 宏组语法与前缀

- 在「宏管理 → Cascade 宏」面板中，可以为宏组配置：
- 配置项：
  - 宏组/名称：在名称处自定义你的这个宏组的名字，“宏组”处可以点击切换不同的宏组
  - 总行数范围`range` （如 `3-5`）；
  - 元素列表（可选权重），用于控制“出场概率”；
  - 可选前缀字段`prefix` ，开启后会自动为每行加上前缀
  - 调用名（ID）：非常关键，作为宏的正确语法的一部分，如下：
- 例如：

  - 组 ID：`plan`
  - `range`：`3-5`
  - `prefix`：`段落`

使用：

```text
{{cascade_plan}}
```

可能输出：

```text
段落1：写代码
段落2：喝咖啡
段落3：看文档
```

### 嵌套与高级用法

- 每一行的元素可以包含其它宏（如 `{{roulette_*}}`、`{{time}}` 等），最终结果会按酒馆的宏解析规则继续展开；
- 当元素值形如 `{{roulette_组ID}}` 时，会直接复用当前扩展中对应 Roulette 宏组的加权逻辑，实现「cascade 中嵌套 roulette」

