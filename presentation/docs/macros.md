# ST-Diff 宏模块：roulette / cascade 使用说明

> 本文档面向终端用户，介绍如何在酒馆中使用 ST-Diff 扩展提供的两个宏：`{{roulette}}` 与 `{{cascade}}`。  
> 运行时文档会以 Markdown 形式渲染成内置弹窗。

<a id="stdiff-doc-roulette"></a>

## 1. `{{roulette}}` 加权随机宏

### 1.1 基本语法（内联）

```text
{{roulette:值1|权重1::值2|权重2::值3|权重3}}
```

- 支持 `::` 或 `,` 作为分隔符：
  - `{{roulette:值1|权重1::值2|权重2}}`
  - `{{roulette:值1|权重1, 值2|权重2}}`
- 每项写成 `内容|权重`：
  - `内容`：任意文本，可以包含其它宏（例如 `{{time}}`、`{{random}}`）。
  - `权重`：数字，允许整数或小数，最终会自动归一化。
- 当所有权重都无效（例如都为 0 或解析失败）时，会退化为“等概率随机”。

示例：

```text
{{roulette:金币|3::银币|1}}
```

大致相当于“75% 概率金币，25% 概率银币”。

### 1.2 宏组语法

为方便复用，可以在“宏管理 → Roulette 宏”面板中配置宏组，例如：

- 组 ID：`loot_basic`
- 条目：
  - `奖励 A` → `100 金币`，权重 `1`
  - `奖励 B` → `{{random::治疗药水::法力药水}}`，权重 `1`

在对话或系统提示中可以直接写：

```text
{{roulette_loot_basic}}
```

效果等价于在原地写出对应的 `{{roulette:...}}` 表达式。

### 1.3 嵌套示例

```text
{{roulette:
  金币*100|0.7::
  {{random::治疗药水::法力药水}}|0.25::
  {{random::铁剑::木盾}}|0.05
}}
```

- 外层 `roulette` 按权重从三项中抽取一项；
- 若抽到第二项，则会继续执行内层 `{{random::治疗药水::法力药水}}`。

### 1.4 安全限制与错误兜底

- 最大嵌套深度为 16 层，超出后会停止展开并返回原文片段；
- 当候选条目全部被禁用或为空时，会直接返回原始宏字符串；
- 运行时问题会在控制台输出 `[ST-Diff][roulette]` 日志，方便排查。

<a id="stdiff-doc-cascade"></a>

## 2. `{{cascade}}` 瀑布式多行宏

### 2.1 基本语法（双冒号）

```text
{{cascade:范围::元素1::元素2::...::元素N}}
```

- `范围`：写成 `min-max`（闭区间），表示最终行数 `N` 会在 `[min, max]` 内随机取整。
- 后续各参数为候选元素，每一行会从这些元素中随机选一个。

示例：

```text
{{cascade:3-5::写代码::喝咖啡::看文档}}
```

可能输出（3–5 行随机）：

```text
喝咖啡
写代码
看文档
喝咖啡
```

### 2.2 宏组语法

可在“宏管理 → Cascade 宏”面板中配置宏组，例如：

- 组 ID：`todo_daily`
- 范围：`3-5`
- 选项：
  - `写代码`
  - `喝咖啡`
  - `看文档`

在模板中直接写：

```text
{{cascade_todo_daily}}
```

即可按上述配置生成多行清单。选项可以配置权重，用来控制“出场频率”。

### 2.3 行前缀与自动编号

如果在 Cascade 组中设置前缀（如 `段落`），输出会变为：

```text
段落1：写代码
段落2：喝咖啡
段落3：看文档
```

- 行号从 1 开始递增；
- 分隔符为全角 `：`。

#### 2.3.1 前缀去重（默认开启，可关闭）

当某个候选元素本身已经以 `前缀:` 或 `前缀：` 开头时，会先移除这一段再注入 `前缀+编号：`，避免出现重复前缀，例如：

```text
段落1：段落：写代码
```

会变为：

```text
段落1：写代码
```

#### 2.3.2 框架内连续编号重排（仅发送给模型）

当你在同一个 `<framework>...</framework>` 块内放置多个相邻的 `{{cascade_*}}`（且它们使用相同前缀）时，为了让编号按最终文本顺序连续递增，ST-Diff 会在“发送给模型”之前做一次后处理重排：

- 只影响最终发送内容。没法在聊天窗口渲染；
- 标签本身不会被删除；
- 每个 `<framework>...</framework>` 块会从 1 重新开始；
- “框架标签名”输入框只需要填 `framework` 这样的标签名，不需要填写尖括号。

### 2.4 嵌套与组合

- 元素内容可以继续包含其它宏，例如：

```text
{{cascade:3-5::{{roulette_loot_basic}}::额外奖励}}
```

- 如果元素写成 `{{roulette_*}}` 形式，内部会优先尝试按 Roulette 组进行解析。

### 2.5 安全限制与错误兜底

- 当 `范围` 无法解析或 `min > max` 时，会记录警告并返回空字符串或原始表达式；
- 为避免极端长输出，内部会限制最大行数（例如 100 行）；
- 元素池为空时，返回空字符串。

## 3. 配置与备份建议

- 所有宏配置保存在扩展设置下：`extensionSettings['st-diff'].macros`；
- 推荐在宏管理工具栏中使用“导出配置”定期备份 Roulette / Cascade 宏组；
- 如果预览结果与预期不符，可以：
  - 打开浏览器控制台，查看 `[ST-Diff][macros]` / `[ST-Diff][roulette]` / `[ST-Diff][cascade]` 日志；
  - 检查是否存在循环引用、权重为 0、范围填错等问题。